<%- include('./partials/header') %>

    <% if(error && error.length > 0){ %>
        <div class="fixed top-5 left-1/2 transform -translate-x-1/2 p-4 rounded-lg bg-red-500 text-white z-50 shadow-lg">
            <div class="flex items-center">
                <i class="ri-error-warning-line mr-2"></i>
                <span><%= error[0] %></span>
            </div>
        </div>
        <% } %>
        
    <% if(success && success.length > 0){ %>
        <div class="fixed top-5 left-1/2 transform -translate-x-1/2 p-4 rounded-lg bg-green-500 text-white z-50 shadow-lg">
            <div class="flex items-center">
                <i class="ri-check-line mr-2"></i>
                <span><%= success[0] %></span>
            </div>
        </div>
        <% } %>

    <!-- Main Shop Content -->
    <div class="min-h-screen bg-gray-50 pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Header Section -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">Shop</h1>
                <p class="text-gray-600">Discover our amazing collection of products</p>
            </div>

            <div class="flex flex-col lg:flex-row gap-8">
                
                <!-- Sidebar -->
                <div class="lg:w-1/4">
                    <div class="bg-white rounded-lg shadow-sm p-6 sticky top-24">
                        
                        <!-- Sort Section -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Sort By</h3>
                            <form action="/shop" method="GET">
                                <select name="sortby" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="popular">Most Popular</option>
                                    <option value="newest">Newest First</option>
                                    <option value="price-low">Price: Low to High</option>
                                    <option value="price-high">Price: High to Low</option>
                                </select>
                            </form>
                        </div>

                        <!-- Categories -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Categories</h3>
                            <div class="space-y-2">
                                <a href="/shop?category=all" class="block text-gray-600 hover:text-blue-600 transition-colors">All Products</a>
                                <a href="/shop?category=new" class="block text-gray-600 hover:text-blue-600 transition-colors">New Collection</a>
                                <a href="/shop?category=discount" class="block text-gray-600 hover:text-blue-600 transition-colors">Discounted Items</a>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Filters</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-600">In Stock</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-600">On Sale</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Grid -->
                <div class="lg:w-3/4">
                    <% if(products && products.length > 0) { %>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <% products.forEach(function(product){ %>
                                <div class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-lg transition-shadow duration-300">
                                    <!-- Product Image -->
                                    <div class="aspect-w-1 aspect-h-1 bg-gray-200 relative overflow-hidden" style="background-color: <%= product.bgcolor || '#f3f4f6' %>;">
                                        <% if(product.image) { %>
                                            <img class="w-full h-64 object-cover object-center" 
                                                 src="data:image/jpeg;base64,<%= product.image.toString('base64') %>" 
                                                 alt="<%= product.name %>"
                                                 loading="lazy">
                                        <% } else { %>
                                            <div class="w-full h-64 flex items-center justify-center bg-gray-100">
                                                <i class="ri-image-line text-4xl text-gray-400"></i>
                                            </div>
                                        <% } %>
                                        
                                        <!-- Discount Badge -->
                                        <% if(product.discount && product.discount > 0) { %>
                                            <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-md text-sm font-medium">
                                                -<%= product.discount %>%
                                            </div>
                                        <% } %>
                                    </div>

                                    <!-- Product Details -->
                                    <div class="p-4" style="background-color: <%= product.panelColor || '#ffffff' %>; color: <%= product.textcolor || '#000000' %>;">
                                        <h3 class="text-lg font-semibold mb-2 truncate"><%= product.name %></h3>
                                        
                                        <% if(product.description) { %>
                                            <p class="text-sm opacity-75 mb-3 line-clamp-2"><%= product.description %></p>
                                        <% } %>

                                        <div class="flex items-center justify-between">
                                            <div class="flex flex-col">
                                                <% if(product.discount && product.discount > 0) { %>
                                                    <span class="text-lg font-bold">₹<%= Math.round(product.price * (1 - product.discount/100)) %></span>
                                                    <span class="text-sm line-through opacity-60">₹<%= product.price %></span>
                                                <% } else { %>
                                                    <span class="text-lg font-bold">₹<%= product.price %></span>
                                                <% } %>
                                            </div>
                                            
                                            <div class="flex items-center space-x-2">
                                                <!-- Quick View Button -->
                                                <button onclick="openProductModal('<%= product._id %>')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-full transition-colors duration-200">
                                                    <i class="ri-eye-line text-lg"></i>
                                                </button>
                                                
                                                <!-- Add to Cart Button -->
                                                <button onclick="addToCart('<%= product._id %>')" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full transition-colors duration-200">
                                                    <i class="ri-shopping-cart-line text-lg"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Stock Status -->
                                        <div class="mt-3">
                                            <% if(product.stock && product.stock > 0) { %>
                                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">In Stock (<%= product.stock %>)</span>
                                            <% } else { %>
                                                <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">Out of Stock</span>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <!-- Empty State -->
                        <div class="text-center py-16">
                            <div class="max-w-md mx-auto">
                                <i class="ri-shopping-bag-line text-6xl text-gray-400 mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-900 mb-2">No Products Available</h3>
                                <p class="text-gray-600 mb-6">We're working hard to add amazing products. Check back soon!</p>
                                <a href="/owners/create-product" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="ri-add-line mr-2"></i>
                                    Add First Product
                                </a>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900" id="modalProductName">Product Details</h2>
                        <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="ri-close-line text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <img id="modalProductImage" class="w-full h-64 object-cover rounded-lg" src="" alt="">
                        </div>
                        
                        <div>
                            <p id="modalProductDescription" class="text-gray-600 mb-4"></p>
                            <div id="modalProductPrice" class="text-2xl font-bold text-blue-600 mb-4"></div>
                            <div id="modalProductStock" class="text-sm text-gray-500 mb-6"></div>
                            
                            <div class="flex space-x-3">
                                <button onclick="addToCartFromModal()" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="ri-shopping-cart-line mr-2"></i>
                                    Add to Cart
                                </button>
                                <button onclick="buyNow()" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="ri-flashlight-line mr-2"></i>
                                    Buy Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-hide flash messages -->
    <script>
        // Products data for JavaScript
        const products = [
            <% if(products && products.length > 0) { %>
                <% products.forEach(function(product, index){ %>
                    {
                        id: '<%= product._id %>',
                        name: '<%= product.name %>',
                        price: <%= product.price %>,
                        discount: <%= product.discount || 0 %>,
                        description: '<%= product.description || "" %>',
                        stock: <%= product.stock || 0 %>,
                        image: 'data:image/jpeg;base64,<%= product.image.toString("base64") %>'
                    }<%= index < products.length - 1 ? ',' : '' %>
                <% }) %>
            <% } %>
        ];

        // Flash message auto-hide
        setTimeout(function() {
            const flashMessages = document.querySelectorAll('[class*="fixed top-5"]');
            flashMessages.forEach(function(msg) {
                msg.style.transition = 'opacity 0.5s';
                msg.style.opacity = '0';
                setTimeout(function() {
                    msg.remove();
                }, 500);
            });
        }, 4000);

        // Product modal functions
        let currentProduct = null;

        function openProductModal(productId) {
            currentProduct = products.find(p => p.id === productId);
            if (!currentProduct) return;

            document.getElementById('modalProductName').textContent = currentProduct.name;
            document.getElementById('modalProductImage').src = currentProduct.image;
            document.getElementById('modalProductDescription').textContent = currentProduct.description;
            
            const finalPrice = currentProduct.discount > 0 
                ? Math.round(currentProduct.price * (1 - currentProduct.discount/100))
                : currentProduct.price;
            
            let priceHTML = `₹${finalPrice}`;
            if (currentProduct.discount > 0) {
                priceHTML += ` <span class="text-lg text-gray-500 line-through">₹${currentProduct.price}</span>`;
                priceHTML += ` <span class="text-sm bg-red-100 text-red-800 px-2 py-1 rounded ml-2">${currentProduct.discount}% OFF</span>`;
            }
            
            document.getElementById('modalProductPrice').innerHTML = priceHTML;
            document.getElementById('modalProductStock').textContent = 
                currentProduct.stock > 0 ? `${currentProduct.stock} items in stock` : 'Out of stock';
            
            document.getElementById('productModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentProduct = null;
        }

        function addToCart(productId) {
            // Find product
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Show loading state
            const button = document.querySelector(`button[onclick="addToCart('${productId}')"]`);
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="ri-loader-4-line animate-spin text-lg"></i>';
            button.disabled = true;

            // Make API call to add to cart
            fetch('/add-to-cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Update cart count in header
                    document.getElementById('cartCount').textContent = data.cartCount;
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                showNotification('Error adding product to cart', 'error');
            })
            .finally(() => {
                // Restore button state
                button.innerHTML = originalHTML;
                button.disabled = false;
            });
        }

        function addToCartFromModal() {
            if (currentProduct) {
                // Show loading state
                const button = document.querySelector('button[onclick="addToCartFromModal()"]');
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>Adding...';
                button.disabled = true;

                // Use the same add to cart function
                fetch('/add-to-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productId: currentProduct.id,
                        quantity: 1
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        document.getElementById('cartCount').textContent = data.cartCount;
                        closeProductModal();
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error adding to cart:', error);
                    showNotification('Error adding product to cart', 'error');
                })
                .finally(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                });
            }
        }

        function buyNow() {
            if (currentProduct) {
                showNotification(`Redirecting to checkout for ${currentProduct.name}`, 'info');
                // Here you would redirect to checkout
                console.log('Buy now:', currentProduct);
                closeProductModal();
            }
        }

        function showNotification(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-5 right-5 ${colors[type]} text-white p-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="ri-check-line mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Slide in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Auto remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Close modal when clicking outside
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProductModal();
            }
        });
    </script>

<%- include('./partials/footer') %>